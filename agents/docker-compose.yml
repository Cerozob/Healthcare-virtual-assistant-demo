# Docker Compose for Healthcare Assistant Agent Development
version: '3.8'

services:
  healthcare-assistant:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      # Model Configuration (set these for local testing)
      - MODEL_ID=${MODEL_ID:-anthropic.claude-3-5-sonnet-20241022-v2:0}
      - MODEL_TEMPERATURE=${MODEL_TEMPERATURE:-0.1}
      - MODEL_MAX_TOKENS=${MODEL_MAX_TOKENS:-4096}
      - MODEL_TOP_P=${MODEL_TOP_P:-0.9}
      
      # Knowledge Base Configuration (set these for testing)
      - KNOWLEDGE_BASE_ID=${KNOWLEDGE_BASE_ID:-}
      - SUPPLEMENTAL_DATA_BUCKET=${SUPPLEMENTAL_DATA_BUCKET:-}
      
      
      # Database Configuration (set these for testing)
      - DATABASE_CLUSTER_ARN=${DATABASE_CLUSTER_ARN:-}
      - DATABASE_SECRET_ARN=${DATABASE_SECRET_ARN:-}
      
      # Agent Configuration
      - DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE:-es-LATAM}
      - STREAMING_ENABLED=${STREAMING_ENABLED:-true}
      - SESSION_TIMEOUT_MINUTES=${SESSION_TIMEOUT_MINUTES:-30}
      
      # Session Management Configuration
      - SESSION_BUCKET=${SESSION_BUCKET:-ab2-cerozob-processeddata-us-east-1}
      - SESSION_PREFIX=${SESSION_PREFIX:-processed/}  # Base prefix, actual: processed/{patient_id}_{data_type}/
      - ENABLE_SESSION_MANAGEMENT=${ENABLE_SESSION_MANAGEMENT:-true}
      
      # Guardrails Configuration (optional for local testing)
      - GUARDRAIL_ID=${GUARDRAIL_ID:-}
      - GUARDRAIL_VERSION=${GUARDRAIL_VERSION:-}
      - BEDROCK_GUARDRAIL_ID=${BEDROCK_GUARDRAIL_ID:-}
      - BEDROCK_GUARDRAIL_VERSION=${BEDROCK_GUARDRAIL_VERSION:-}
      
      # Observability Configuration
      - ENABLE_TRACING=${ENABLE_TRACING:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - METRICS_NAMESPACE=${METRICS_NAMESPACE:-Healthcare/Agents}
      
      # AWS Configuration (for local testing with AWS credentials)
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
    
    volumes:
      # Mount logs directory for local development
      - ./logs:/app/logs
      
      # Mount AWS credentials if available
      - ~/.aws:/home/agentuser/.aws:ro
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    restart: unless-stopped
    
    # Resource limits for local development
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'

  # Optional: Local PostgreSQL for testing (if not using AWS RDS)
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=healthcare
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../lambdas/shared/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    profiles:
      - local-db

  # Optional: LocalStack for AWS services simulation
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,secretsmanager,bedrock
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
    volumes:
      - localstack_data:/tmp/localstack
    profiles:
      - localstack

volumes:
  postgres_data:
  localstack_data:
